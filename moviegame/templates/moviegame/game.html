{% extends "moviegame/base.html" %}
{% load i18n %}

{% block title %}Play • Movidle{% endblock %}

{% block head %}
<script>
function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v?v.pop():"";}

async function autocomplete(q){
  if(!q || q.length<1) return [];
  const r = await fetch(`/api/autocomplete/?q=${encodeURIComponent(q)}&limit=24`);
  const j = await r.json(); return j.results || [];
}

function renderSuggest(list){
  const c = document.getElementById("sugerencias"); c.innerHTML="";
  list.forEach(it=>{
    const d = document.createElement("div"); d.className="opt";
    d.textContent = `${it.titulo} (${it.anio})`;
    d.onclick = ()=>{ c.innerHTML=""; enviarIntento(it.id, it.titulo); };
    c.appendChild(d);
  });
}

function tile(label, color, arrow, valueText){
  const a = arrow==="UP"?"▲":(arrow==="DOWN"?"▼":"");
  return `
    <div class="tile ${color}">
      <div class="t-label">${label}</div>
      <div class="t-sub">${valueText || ""} <span class="t-arrow">${a}</span></div>
    </div>`;
}

function num(n){return (n==null)? "" : n.toLocaleString();}
function minutes(n){return (n==null)? "" : `${n} min`;}
function rating(n){return (n==null)? "" : Number(n).toFixed(1);}

function addCard(titulo, j){
  const card = document.createElement("div");
  card.className = "guess-card appear";

  const tiles =
    tile("Año", j.colorAño, j.arrowAño, j.valAño) +
    tile("Popularidad (votos)", j.colorPopularidad, j.arrowPopularidad, num(j.valPopularidad)) +
    tile("Géneros", j.colorGeneros, "", j.valGeneros) +
    tile("Duración", j.colorDuración, j.arrowDuración, minutes(j.valDuración)) +
    tile("Director", j.colorDirector, "", j.valDirector) +
    tile("Actores", j.colorActores, "", j.valActores) +
    tile("IMDb Rating", j.colorRating, "", rating(j.valRating));

  card.innerHTML = `<div class="g-head movie-title">${titulo}</div><div class="tiles">${tiles}</div>`;
  document.getElementById("guesses").prepend(card);
}

async function enviarIntento(id, tituloMostrado){
  const input = document.getElementById("titulo");
  const data = new URLSearchParams();
  if(id) data.append("pelicula_id", id);
  if(!id && input.value.trim()) data.append("titulo", input.value.trim());

  const r = await fetch("{% url 'moviegame:api_intentos' %}", {
    method:"POST", headers:{"X-CSRFToken":getCookie("csrftoken")}, body:data
  });
  const j = await r.json();
  if(!r.ok){ alert(j.error || "Error"); return; }

  if (j.numero_intento){
    document.getElementById("guess-counter").innerText = `Guess ${j.numero_intento} de {{ max_intentos }}`;
    const titulo = tituloMostrado || input.value.trim() || "Guess";
    addCard(titulo, j);
    input.value="";
  }
  if (j.estadoPartida && j.estadoPartida !== "EN_CURSO"){
    openResult(j.revealTitle, j.revealAño, j.revealPoster);
    input.disabled = true;
    const btn = document.getElementById("btn-buscar"); if(btn) btn.disabled = true; // por si existe en tu CSS antiguo
  }
  if (j.error){ console.log(j.error); }
}

function openResult(titulo, anio, poster){
  const m = document.getElementById("modal-result");
  document.getElementById("res-title").innerText = `${titulo} (${anio})`;
  const img = document.getElementById("res-poster");
  if (poster){ img.src = poster; img.style.display="block"; } else { img.style.display="none"; }
  m.classList.remove("hidden");
}

document.addEventListener("DOMContentLoaded", ()=>{
  const input = document.getElementById("titulo");
  input?.addEventListener("input", async (e)=> renderSuggest(await autocomplete(e.target.value.trim())));
  document.getElementById("form-intento")?.addEventListener("submit", (e)=>{
    e.preventDefault(); if (input.value.trim()) enviarIntento(null, null);
  });
  document.querySelector("#modal-result .close")?.addEventListener("click", ()=>{
    document.getElementById("modal-result").classList.add("hidden");
  });
});
</script>

<style>
/* ===== /play polish (solo front) ===== */

/* Barra de guess centrada (sin lupa) */
.guess-bar{ max-width:760px; margin:16px auto 12px; }
.guess-input{
  width:100%; padding:14px 16px; border:1px solid var(--border,#e5e7eb);
  border-radius:999px; background:#fff; outline:none;
  transition: box-shadow .15s ease, border-color .15s ease;
}
.guess-input:focus{ border-color: var(--brand,#ff5a4e); box-shadow:0 0 0 3px rgba(255,90,78,.25); }

/* Contador y contenedor superior */
.play-top{ max-width:1100px; margin:0 auto; }
#guess-counter{ margin:6px 0 4px; font-weight:600; }

/* Grid centrado para tarjetas */
.guesses{
  max-width:1100px; margin:12px auto 0;
  display:grid; gap:16px;
}
.guess-card{
  background: var(--brand-soft, #ff6b5f1a);
  border: 1px solid rgba(0,0,0,.04);
  border-radius:16px; padding:16px;
  box-shadow: 0 10px 24px rgba(16,24,40,.06);
}
.guess-card .tiles{
  display:grid; gap:12px; margin-top:10px;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

/* Título de la película más grande */
.g-head.movie-title{
  font-size: clamp(22px, 3.2vw, 34px);
  font-weight: 800; letter-spacing:.2px;
}

/* Animación de entrada pro (stagger básico) */
.appear{ animation: cardIn .32s ease both; }
@keyframes cardIn{
  from{ opacity:0; transform:translateY(8px) scale(.98); }
  to{   opacity:1; transform:translateY(0)   scale(1); }
}

/* Tiles: blancos por defecto (para reemplazar “negros”) */
.tile{
  background:#fff; border:1px solid var(--border,#e5e7eb);
  border-radius:14px; padding:12px;
  transition: transform .12s ease, box-shadow .12s ease;
}
.tile:hover{ transform:translateY(-2px); box-shadow:0 12px 26px rgba(16,24,40,.08); }

/* Si tu CSS anterior define clases como .dark/.gray/.neutral,
   las forzamos a blanco al inicio para mantener estética */
.tile.dark, .tile.gray, .tile.neutral, .tile.default{
  background:#fff !important; color:var(--text,#1f2937) !important;
}

/* Etiquetas dentro de cada tile */
.t-label{ font-weight:800; margin:0 0 6px; }
.t-sub{ margin:0; }
.t-arrow{ opacity:.6; margin-left:4px; }

/* Sugerencias del autocomplete (sin tocar tu JS) */
.suggest{ max-width:760px; margin:8px auto 0; }
.suggest .opt{
  padding:8px 10px; border:1px solid var(--border,#e5e7eb); border-top:0;
  background:#fff; cursor:pointer;
}
.suggest .opt:hover{ background:#fafafa; }

/* Responsive */
@media (max-width:640px){
  .g-head.movie-title{ text-align:center; }
}
</style>
{% endblock %}

{% block content %}
  {% if no_game_msg %}
    <div class="card"><p class="muted">{{ no_game_msg }}</p></div>
  {% else %}
    <div class="play-top">
      <div id="guess-counter">
        {% blocktrans %}Intento {{ guess_now }} de {{ max_intentos }}{% endblocktrans %}
      </div>

      <!-- Barra de búsqueda centrada, SIN lupa -->
      <form id="form-intento" class="guess-bar" autocomplete="off" novalidate>
        {% csrf_token %}
        <input id="titulo" class="guess-input" placeholder="{% trans 'Ingresa un intento aquí…' %}" />
      </form>

      <div id="sugerencias" class="suggest"></div>
    </div>

    <!-- Tarjetas centradas con animación -->
    <div id="guesses" class="guesses"></div>

    <!-- Modal resultado (solo cuando termina) -->
    <div id="modal-result" class="modal hidden">
      <div class="modal-card">
        <div class="modal-head">
          <h3>{% trans "La película de hoy es..." %}</h3>
          <button class="close">×</button>
        </div>
        <img id="res-poster" style="max-height:220px;border-radius:12px;display:none"/>
        <h3 id="res-title" style="margin-top:8px"></h3>
      </div>
    </div>
  {% endif %}
{% endblock %}

