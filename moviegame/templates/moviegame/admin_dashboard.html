{% extends "moviegame/base.html" %}
{% block title %}Panel • Movidle{% endblock %}

{% block head %}
<script>
function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v?v.pop():"";}

async function autocomplete(q){
  if(!q || q.length<1) return [];
  const r = await fetch(`/api/autocomplete/?q=${encodeURIComponent(q)}&limit=20`);
  const j = await r.json(); return j.results || [];
}

function renderSuggest(list){
  const c = document.getElementById("sugerencias"); c.innerHTML="";
  if(!list.length){ c.classList.add("hidden"); return; }
  c.classList.remove("hidden");
  list.forEach(it=>{
    const d = document.createElement("div"); d.className="opt";
    d.textContent = `${it.titulo} (${it.anio})`;
    d.onclick = ()=>{ c.innerHTML=""; c.classList.add("hidden"); setDaily(it.id); };
    c.appendChild(d);
  });
}

async function setDaily(id){
  const data = new URLSearchParams(); data.append("pelicula_id", id);
  const r = await fetch("{% url 'moviegame:admin_set_daily' %}", {
    method:"POST", headers:{"X-CSRFToken":getCookie("csrftoken")}, body:data
  });
  // si la vista redirige, seguimos su redirección (tu comportamiento actual)
  if(r.redirected){ window.location = r.url; } else { location.reload(); }
}

document.addEventListener("DOMContentLoaded", ()=>{
  const input = document.getElementById("titulo");
  input?.addEventListener("input", async (e)=>{
    const q = e.target.value.trim();
    renderSuggest(await autocomplete(q));
  });
  // cerrar lista al hacer click fuera
  document.addEventListener("click",(ev)=>{
    const box = document.querySelector(".search-wrap");
    if(!box?.contains(ev.target)){
      const sug = document.getElementById("sugerencias");
      if(sug){ sug.innerHTML=""; sug.classList.add("hidden"); }
    }
  });
});
</script>

<style>
:root{ --brand:#ff5a4e; --border:#e5e7eb; --ink:#0f172a; }

/* Contenedor del panel */
.admin-shell{ max-width: 980px; margin: 0 auto; }

/* Tarjeta roja principal (manteniendo tu .card.red) */
.card.red{
  background: var(--brand);
  color: #fff;
  border: 0;
  border-radius: 18px;
  box-shadow: 0 18px 40px rgba(16,24,40,.12);
  padding: 20px;
}

/* Cabecera dentro de la card */
.card.red h2{
  margin: 0 0 6px;
  font-weight: 800;
  letter-spacing: .2px;
}
.daily-meta{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  margin-bottom: 10px;
}
.daily-chip{
  background: rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.35);
  color:#fff; padding:6px 10px; border-radius:999px; font-weight:600;
}

/* Título actual */
.daily-current{
  margin: 4px 0 14px;
  font-weight: 800;
}
.daily-current b{ color:#fff; }

/* Buscador (píldora) */
.search-wrap{ position: relative; }
.search-wrap input{
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #ffd0cb;        /* suave, combina con el rojo */
  border-radius: 999px;              /* pill */
  background: #fff;
  color: var(--ink);
  outline: none;
  transition: box-shadow .15s ease, border-color .15s ease;
}
.search-wrap input:focus{
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(255,90,78,.25);
}

/* Lista de sugerencias */
.suggest{
  position: absolute; left:0; right:0; top: calc(100% + 6px);
  background: #fff; border: 1px solid var(--border);
  border-radius: 12px; overflow: hidden;
  box-shadow: 0 14px 36px rgba(16,24,40,.12);
  z-index: 20;
}
.suggest.hidden{ display:none; }
.suggest .opt{
  padding: 10px 12px; cursor: pointer;
  border-top: 1px solid #f1f5f9;
}
.suggest .opt:first-child{ border-top: 0; }
.suggest .opt:hover{ background: #f8fafc; }

/* Texto secundario dentro de la card roja */
.card.red .muted{ color: rgba(255,255,255,.85); }

/* Responsive */
@media (max-width:640px){
  .daily-meta{ flex-direction: column; align-items: flex-start; }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-shell">
  <div class="card red">
    <div class="daily-meta">
      <h2>Película del día</h2>
      <span class="daily-chip">Hoy: {{ now|date:"D d M" }}</span>
    </div>

    {% if secreta %}
      <p class="daily-current">
        <b>{{ secreta.titulo }}</b> ({{ secreta.anio }})
      </p>
    {% else %}
      <p class="muted">Aún no hay película seleccionada para hoy.</p>
    {% endif %}

    <div class="search-wrap">
      <input id="titulo" placeholder="Buscar película para fijar hoy…" autocomplete="off">
      <div id="sugerencias" class="suggest hidden"></div>
    </div>
  </div>
</div>
{% endblock %}
